<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Earth ¬∑ Grounded Night Field ‚Äî PLNT Earth</title>
<meta name="description" content="Earth field with 128 Hz Warmth & 136.1 Hz O-tone, Earth Good Points, and a Music Deck with one-tap Play & Tune. Gentle alter.fire fallback and daily logging vibe. Everything here is for everyone."/>
<meta name="theme-color" content="#0b0d11" media="(prefers-color-scheme: dark)"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="illumina" content="128 Hz ¬∑ Shared Field"/>
<style>
:root{
  --bg:#0b0d11; --ink:#e9ecf4; --muted:#a9a9b6; --ring:#1b2030; --card:#0f1426;
  --mint:#b2f5ea; --lav:#c8b6ff; --gold:#ffd66e; --rose:#ff8fb3; --leaf:#80e2a7; --vio:#8ea2ff;
  --accent: var(--lav); --glow: rgba(200,182,255,.25);
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
a{color:var(--mint);text-decoration:none}
a:hover{opacity:.9}
.wrap{max-width:1040px;margin:0 auto;padding:24px env(safe-area-inset-right,16px) 24px env(safe-area-inset-left,16px)}
header{display:flex;justify-content:space-between;align-items:center;gap:12px}
.brand{display:flex;align-items:center;gap:12px}
.glyph{width:34px;height:34px;border-radius:50%;
  background:radial-gradient(120% 120% at 25% 25%, var(--accent), transparent 60%), linear-gradient(#1a1e33,#0f1426);
  box-shadow:0 0 24px 4px var(--glow);
}
h1{margin:0;font-size:clamp(22px,2.6vw,34px)}
.subtitle{color:var(--muted);font-size:14px}
.hero{margin:16px 0 18px;border:1px solid var(--ring);border-radius:20px;padding:16px;
  background:radial-gradient(1200px 300px at 50% -70%, var(--glow), transparent 60%), linear-gradient(180deg,#0b0d11,#0b0d11);}
.hero p{margin:8px 0 0;color:var(--muted)}

.section-grid{display:grid;gap:14px;grid-template-columns:1.1fr 1fr}
@media (max-width:980px){.section-grid{grid-template-columns:1fr}}
.card{border:1px solid var(--ring);border-radius:16px;background:var(--card);padding:14px}
h2{margin:0 0 8px;font-size:18px}
.note{color:var(--muted);font-size:13px;line-height:1.4}

.controls{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:740px){.controls{grid-template-columns:1fr}}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.btn{
  appearance:none;border:1px solid var(--ring);background:#0e1430;color:var(--ink);
  padding:10px 14px;border-radius:12px;font-size:14px;cursor:pointer;transition:transform .12s ease,opacity .2s;}
.btn[disabled]{opacity:.55;cursor:not-allowed}
.btn:hover{transform:translateY(-1px)}
.input{background:#0e1430;border:1px solid var(--ring);color:var(--ink);border-radius:10px;padding:8px 10px}
.range{width:170px}
.small{font-size:12px}

.modebar{display:flex;flex-wrap:wrap;gap:8px}
.modebar .mode{border:1px solid var(--ring);padding:8px 10px;border-radius:999px;font-size:13px;background:#0e1430;opacity:.92;cursor:pointer}
.modebar .mode.active{outline:1px solid var(--accent);box-shadow:0 0 16px 2px var(--glow);opacity:1}

.leds{display:flex;gap:10px;margin-top:8px}
.led{width:12px;height:12px;border-radius:50%;border:1px solid var(--ring);background:#12182d;box-shadow:0 0 0 0 transparent;transition:box-shadow .2s ease, background .2s ease}
.led.on{background:#241b44;box-shadow:0 0 10px 2px rgba(200,182,255,.55)}
.led.warm{background:#12302a;box-shadow:0 0 12px 2px rgba(128,226,167,.5)}

.grid-3{display:grid;gap:10px;grid-template-columns:repeat(3,1fr)}
@media (max-width:800px){.grid-3{grid-template-columns:1fr}}

footer{margin:18px 0 6px;padding:14px 10px;text-align:center;border-top:1px solid var(--ring);color:var(--muted)}
.resonance-ribbon{letter-spacing:.05em}
.resonance-ribbon a{color:var(--mint)}
.warmth-aura{filter:drop-shadow(0 0 10px rgba(200,182,255,.4))}

/* THEMES (night-optimized) via [data-theme] */
[data-theme="ground"]  { --accent: var(--leaf); --glow: rgba(128,226,167,.22); --card:#0e1624; }
[data-theme="air"]     { --accent: var(--mint); --glow: rgba(178,245,234,.25); --card:#0d1726; }
[data-theme="sexy"]    { --accent: var(--rose); --glow: rgba(255,143,179,.22); --card:#111326; }
[data-theme="silky"]   { --accent: var(--lav);  --glow: rgba(200,182,255,.25); --card:#0f1426; }
[data-theme="rooted"]  { --accent: #86efac;     --glow: rgba(134,239,172,.22); --card:#0e1822; }
[data-theme="venus"]   { --accent: #ffd6a8;     --glow: rgba(255,214,168,.25); --card:#161225; }
[data-theme="venus"] .hero{background:
  radial-gradient(1200px 300px at 50% -70%, rgba(255,214,168,.12), transparent 60%),
  linear-gradient(180deg,#0b0d11,#0b0d11);}
</style>
</head>
<body data-theme="ground">
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="glyph" aria-hidden="true"></div>
        <div>
          <h1>Earth ¬∑ Grounded Night Field</h1>
          <div class="subtitle">Optimized for iPhone 17 Air & headphones ¬∑ Everything here is for everyone.</div>
        </div>
      </div>
    </header>

    <section class="hero">
      <p><strong>Welcome.</strong> Start the tone, choose a mode, and take one good action. Return daily to log points and soak in music. The field stays warm every visit.</p>
    </section>

    <!-- alter.fire fallback card -->
    <section class="card" style="margin-top:12px">
      <h2>Need a stronger spark?</h2>
      <p class="note">If Earth feels soft but you want immediate activation, try the Fire field. It‚Äôs the same Illumina engine with a hotter archetype.</p>
      <a class="btn" href="https://alter.fire" target="_blank" rel="noopener" style="margin-top:8px">Go to alter.fire</a>
      <p class="note small" style="margin-top:6px">Tip: Start low on Fire, then return here to stabilize and log.</p>
    </section>

    <!-- TONE + MODES -->
    <section class="section-grid">
      <!-- Warmth / O-tone Engine -->
      <div class="card">
        <h2>Warmth & O-tone</h2>
        <p class="note">Two gentle presets: <b>128 Hz Warmth</b> (steady grounding) and <b>136.1 Hz O-tone</b> (soft ‚ÄúOm‚Äù feel). Use headphones if you can.</p>
        <div class="controls" style="margin-top:10px">
          <div class="card">
            <div class="row" style="justify-content:space-between">
              <strong>Engine</strong>
              <span id="stateLabel" aria-live="polite">idle</span>
            </div>
            <div class="row" style="margin-top:8px">
              <button class="btn" id="startBtn">Start</button>
              <button class="btn" id="stopBtn" disabled>Stop</button>
              <button class="btn" id="preset128" aria-pressed="true">128 Warmth</button>
              <button class="btn" id="preset136">136.1 O-tone</button>
            </div>
            <div class="row" style="margin-top:8px">
              <label class="note" for="freq">Freq</label>
              <input id="freq" class="input" type="number" min="60" max="300" value="128" style="width:84px"/>
              <label class="note" for="gain" style="margin-left:4px">Level</label>
              <input id="gain" class="range" type="range" min="0" max="100" value="9"/>
            </div>
            <div class="row" style="margin-top:8px">
              <label class="note" for="detune">Air detune (¬±0.50 Hz)</label>
              <input id="detune" class="range" type="range" min="-50" max="50" value="6"/>
              <label class="note" for="width">Stereo width</label>
              <input id="width" class="range" type="range" min="0" max="100" value="90"/>
            </div>
            <div class="row" style="margin-top:8px">
              <label class="note"><input id="sub64" type="checkbox" class="input" style="width:auto;margin-right:6px"/>Sub-ground 64 Hz</label>
              <label class="note"><input id="pink" type="checkbox" class="input" style="width:auto;margin-right:6px"/>Silk noise veil</label>
            </div>
            <div class="leds">
              <div class="led" id="ledCtx" title="AudioContext state"></div>
              <div class="led" id="ledTone" title="Tone health"></div>
            </div>
            <p class="note small" style="margin-top:8px">iOS may pause when fully locked; dim the screen for long sessions.</p>
          </div>

          <div class="card">
            <strong>Quick Check</strong>
            <div class="row" style="margin-top:6px">
              <button class="btn" id="leftOnly">Left</button>
              <button class="btn" id="rightOnly">Right</button>
              <button class="btn" id="both">Both</button>
            </div>
            <p class="note" style="margin-top:8px">Smooth, non-scratchy hum = healthy. If dropouts: lower Level slightly, then restart.</p>
          </div>
        </div>
      </div>

      <!-- Modes -->
      <div class="card">
        <h2>Modes</h2>
        <div class="modebar" id="modebar" role="tablist" aria-label="Theme Modes">
          <button class="mode active" data-mode="ground" role="tab" aria-selected="true">Ground</button>
          <button class="mode" data-mode="air" role="tab">Air</button>
          <button class="mode" data-mode="sexy" role="tab">Sexy</button>
          <button class="mode" data-mode="silky" role="tab">Silky</button>
          <button class="mode" data-mode="rooted" role="tab">Rooted</button>
          <button class="mode" data-mode="venus" role="tab">Venus</button>
        </div>
        <div class="card" style="margin-top:10px">
          <strong>Headphone placement</strong>
          <ul class="note" style="margin:8px 0 0; padding-left:18px">
            <li>Over-ear or good in-ear; start low.</li>
            <li>Ground = centered width; sub-64 adds chest/abdomen warmth.</li>
            <li>Air = wider stereo + slight detune.</li>
            <li>Silky = add pink veil to soften edges.</li>
            <li>Sexy = warm width + small positive detune (body-felt shimmer).</li>
            <li>Rooted = narrow width + sub-ground to anchor.</li>
            <li>Venus = soft gold-lavender glow; breathe slowly.</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- EARTH GOOD POINTS -->
    <section class="card" style="margin-top:14px">
      <h2>Earth Good Points</h2>
      <p class="note">Simple actions you can do today ‚Äî no permission, no waiting. Points stay on your device. Do one, then another.</p>
      <div class="grid-3" id="pointsGrid" style="margin-top:8px">
        <button class="btn" data-action="kind-note" data-points="5">Send a kind note (5)</button>
        <button class="btn" data-action="plant-meal" data-points="8">Plant-based meal (8)</button>
        <button class="btn" data-action="walk-cycle" data-points="6">Walk / cycle errand (6)</button>
        <button class="btn" data-action="pick-litter" data-points="7">Pick up litter (7)</button>
        <button class="btn" data-action="learn-10" data-points="4">Learn 10 min (4)</button>
        <button class="btn" data-action="donate-1" data-points="10">$1 to a local need (10)</button>
        <button class="btn" data-action="share-seed" data-points="5">Share a seed / idea (5)</button>
        <button class="btn" data-action="cook-share" data-points="9">Cook & share food (9)</button>
        <button class="btn" data-action="rest-gently" data-points="3">Rest gently, no doomscroll (3)</button>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="card" style="min-width:220px">
          <strong>Total</strong>
          <div class="note" id="totalPoints" style="font-size:22px;margin-top:6px">0</div>
        </div>
        <div class="card" style="min-width:220px">
          <strong>Streak</strong>
          <div class="note" id="streakDays" style="font-size:22px;margin-top:6px">0 days</div>
        </div>
        <div class="card" style="min-width:280px">
          <strong>Why it matters</strong>
          <p class="note" style="margin-top:6px">Small actions compound. This score is a mirror, not judgment.</p>
        </div>
      </div>
      <p class="note small" style="margin-top:8px">Tip: Add Earth to your Home Screen; tap after each action to keep momentum.</p>
    </section>

    <!-- MUSIC DECK (prefilled + Play & Tune) -->
    <section class="card" style="margin-top:14px">
      <h2>Music Deck</h2>
      <p class="note">Tap <b>Play &amp; Tune</b> for one-tap video load + tone/mode preset. (You can edit URLs.)</p>
      <div class="grid-3" style="margin-top:8px">
        <div class="card">
          <strong>AURORA ‚Äî The Seed</strong>
          <input id="yt1" class="input" value="https://www.youtube.com/watch?v=_Mc_OM5oNA8"/>
          <div class="row" style="margin-top:8px">
            <button class="btn" data-slot="1" id="load1">Load</button>
            <label class="note small"><input type="checkbox" id="loop1" style="width:auto;margin-right:6px" checked/>Loop</label>
            <button class="btn" id="playTune1" title="Load + set 136.1 Hz O-tone, Air mode">Play &amp; Tune</button>
          </div>
          <div id="frame1" style="margin-top:8px"></div>
        </div>
        <div class="card">
          <strong>AURORA ‚Äî Running With The Wolves (Nature Version)</strong>
          <input id="yt2" class="input" value="https://www.youtube.com/watch?v=06ht9MyJLT4"/>
          <div class="row" style="margin-top:8px">
            <button class="btn" data-slot="2" id="load2">Load</button>
            <label class="note small"><input type="checkbox" id="loop2" style="width:auto;margin-right:6px" checked/>Loop</label>
            <button class="btn" id="playTune2" title="Load + set 128 Hz Warmth, Air mode">Play &amp; Tune</button>
          </div>
          <div id="frame2" style="margin-top:8px"></div>
        </div>
        <div class="card">
          <strong>Bon Iver ‚Äî Holocene</strong>
          <input id="yt3" class="input" value="https://www.youtube.com/watch?v=TWcyIpul8OE"/>
          <div class="row" style="margin-top:8px">
            <button class="btn" data-slot="3" id="load3">Load</button>
            <label class="note small"><input type="checkbox" id="loop3" style="width:auto;margin-right:6px" checked/>Loop</label>
            <button class="btn" id="playTune3" title="Load + set 128 Hz Warmth, Silky mode">Play &amp; Tune</button>
          </div>
          <div id="frame3" style="margin-top:8px"></div>
        </div>
      </div>
      <p class="note small" style="margin-top:8px">Loop uses the ID-as-playlist trick for seamless looping after interaction (varies by video).</p>
    </section>

    <!-- UNIFIED FIELD RIBBON -->
    <footer>
      <div class="resonance-ribbon" id="ribbon">
        <a href="https://froot.plnt.earth" target="_blank" rel="noopener">FROOT</a> ¬∑
        <a href="https://tunes.plnt.earth" target="_blank" rel="noopener">TUNES</a> ¬∑
        <a href="https://jar.plnt.earth" target="_blank" rel="noopener">JAR</a> ¬∑
        <a href="https://earth.plnt.earth" target="_blank" rel="noopener">EARTH</a> ¬∑
        <a href="https://charter.plnt.earth" target="_blank" rel="noopener">CHARTER</a> ¬∑
        <a href="https://warmth.plnt.earth" target="_blank" rel="noopener">WARMTH TEST</a>
      </div>
      <div class="note">part of the Illumina 42-day field ¬∑ tone = 128 Hz / 136.1 Hz ¬∑ everything here is for everyone</div>
      <div class="note" style="margin-top:8px">
        üî• Prefer a quicker release? Visit <a href="https://alter.fire" target="_blank" rel="noopener">alter.fire</a> ‚Äî then come back to Earth to stabilize.
      </div>
    </footer>
  </div>

<script>
/* ---------- Audio Engine: 128 Warmth + 136.1 O-tone (no console logs) ---------- */
(() => {
  let ctx=null, master=null, l=null, r=null, panL=null, panR=null, sub=null, pinkNode=null;
  const startBtn = document.getElementById('startBtn');
  const stopBtn  = document.getElementById('stopBtn');
  const preset128= document.getElementById('preset128');
  const preset136= document.getElementById('preset136');
  const freqEl   = document.getElementById('freq');
  const gainEl   = document.getElementById('gain');
  const detuneEl = document.getElementById('detune'); // ¬±0.50 Hz (x/100)
  const widthEl  = document.getElementById('width');
  const subCB    = document.getElementById('sub64');
  const pinkCB   = document.getElementById('pink');
  const ledCtx   = document.getElementById('ledCtx');
  const ledTone  = document.getElementById('ledTone');
  const stateLabel = document.getElementById('stateLabel');
  const ribbon   = document.getElementById('ribbon');

  function aura(on){ ribbon.classList.toggle('warmth-aura', !!on); ledCtx.className = 'led ' + (on?'on':''); }
  function health(ok){ ledTone.className = 'led ' + (ok ? 'warm' : 'on'); }
  function label(t){ stateLabel.textContent=t; }

  function createCtx(){
    ctx = new (window.AudioContext||window.webkitAudioContext)();
    master = ctx.createGain(); master.gain.value = (parseInt(gainEl.value,10)||9)/100;
    master.connect(ctx.destination);

    l = ctx.createOscillator(); r = ctx.createOscillator(); l.type='sine'; r.type='sine';
    panL = ctx.createStereoPanner ? ctx.createStereoPanner() : null;
    panR = ctx.createStereoPanner ? ctx.createStereoPanner() : null;
    if(panL){ panL.pan.value = -0.0001; } if(panR){ panR.pan.value = 0.0001; }

    const hz = +freqEl.value || 128;
    const d  = (parseInt(detuneEl.value,10)||0)/100; // Hz
    if(l.frequency && r.frequency){
      l.frequency.value = hz - d/2;
      r.frequency.value = hz + d/2;
    }

    if(panL){ l.connect(panL).connect(master); } else { l.connect(master); }
    if(panR){ r.connect(panR).connect(master); } else { r.connect(master); }

    if(subCB.checked){
      sub = ctx.createOscillator(); sub.type='sine'; sub.frequency.value=64;
      const sg = ctx.createGain(); sg.gain.value = Math.min(master.gain.value*0.7, 0.06);
      sub.connect(sg).connect(master);
    }
    if(pinkCB.checked){
      const bufferSize = 4096;
      const node = (ctx.createScriptProcessor ? ctx.createScriptProcessor(bufferSize,1,1) : null);
      if(node){
        let b0=0,b1=0,b2=0,b3=0,b4=0,b5=0,b6=0;
        node.onaudioprocess = function(e){
          const out = e.outputBuffer.getChannelData(0);
          for(let i=0;i<out.length;i++){
            const white = Math.random()*2-1;
            b0=0.99886*b0+white*0.0555179; b1=0.99332*b1+white*0.0750759; b2=0.96900*b2+white*0.1538520;
            b3=0.86650*b3+white*0.3104856; b4=0.55000*b4+white*0.5329522; b5=-0.7616*b5-white*0.0168980;
            out[i]=(b0+b1+b2+b3+b4+b5+b6*0.5362)*0.02; b6=white*0.115926;
          }
        };
        pinkNode = node; node.connect(master);
      }
    }
    setWidth(widthEl.value);
  }

  function start(){
    if(!ctx || ctx.state==='closed'){ createCtx(); }
    if(ctx.state==='suspended'){ ctx.resume(); }
    const now = ctx.currentTime;
    try{ l.start(now+0.01); r.start(now+0.01); if(sub){ sub.start(now+0.02);} }catch(e){}
    label('tone on'); startBtn.disabled=true; stopBtn.disabled=false; aura(true); health(true);
    if('mediaSession' in navigator){
      navigator.mediaSession.metadata = new MediaMetadata({title:'Earth ¬∑ Tone', artist:'PLNT Earth', album:'Unified Field'});
    }
    localStorage.setItem('earth_warmth','on');
  }
  function stop(){
    if(!ctx) return;
    try{ l.stop(); r.stop(); if(sub){sub.stop();} }catch(e){}
    try{ if(pinkNode){ pinkNode.disconnect(); pinkNode=null; } }catch(e){}
    try{ ctx.close(); }catch(e){}
    ctx=master=l=r=panL=panR=sub=null;
    startBtn.disabled=false; stopBtn.disabled=true; label('idle'); aura(false); health(false);
    localStorage.setItem('earth_warmth','off');
  }

  function setLevel(v){ if(master){ const t=Math.max(0,Math.min(1,(parseInt(v,10)||0)/100)); master.gain.setTargetAtTime(t, ctx.currentTime||0, .03); } }
  function setFreq(hz){
    const base = Math.max(60,Math.min(300, hz||128));
    const d = (parseInt(detuneEl.value,10)||0)/100;
    if(l&&r){ l.frequency.setValueAtTime(base - d/2, ctx.currentTime||0); r.frequency.setValueAtTime(base + d/2, ctx.currentTime||0); }
  }
  function setDetune(val){
    const d = (parseInt(val,10)||0)/100;
    if(l&&r&&l.frequency&&r.frequency){
      const base = +freqEl.value || 128;
      l.frequency.setValueAtTime(base - d/2, ctx.currentTime||0);
      r.frequency.setValueAtTime(base + d/2, ctx.currentTime||0);
    }
  }
  function setWidth(v){
    const w = (parseInt(v,10)||0)/100;
    if(panL){ panL.pan.value = -w; } if(panR){ panR.pan.value =  w; }
  }

  // Expose helpers for Play & Tune
  window.__earthAudio = {
    start, stop, setFreq, setDetune, setWidth,
    setPreset(hz){ freqEl.value = hz; setFreq(hz);
      preset128.setAttribute('aria-pressed', hz==128 ? 'true':'false');
      preset136.setAttribute('aria-pressed', hz==136.1 ? 'true':'false');
      localStorage.setItem('earth_preset', String(hz));
    },
    setOptions({sub=false, pink=false}){
      subCB.checked=sub; pinkCB.checked=pink;
      const running = ctx && ctx.state==='running';
      if(running){ stop(); start(); }
    },
    setMode(m){
      const modes = document.querySelectorAll('.modebar .mode');
      modes.forEach(x=>x.classList.remove('active'));
      const btn = document.querySelector(`.modebar .mode[data-mode="${m}"]`);
      if(btn){ btn.classList.add('active'); }
      const presets = {
        ground: ()=>{ document.body.setAttribute('data-theme','ground'); widthEl.value=40; setWidth(40); detuneEl.value=0; setDetune(0); },
        air:    ()=>{ document.body.setAttribute('data-theme','air');    widthEl.value=100; setWidth(100); detuneEl.value=8; setDetune(8); },
        sexy:   ()=>{ document.body.setAttribute('data-theme','sexy');   widthEl.value=85; setWidth(85); detuneEl.value=10; setDetune(10); },
        silky:  ()=>{ document.body.setAttribute('data-theme','silky');  widthEl.value=70; setWidth(70); detuneEl.value=6; setDetune(6); },
        rooted: ()=>{ document.body.setAttribute('data-theme','rooted'); widthEl.value=20; setWidth(20); detuneEl.value=0; setDetune(0); },
        venus:  ()=>{ document.body.setAttribute('data-theme','venus');  widthEl.value=65; setWidth(65); detuneEl.value=5; setDetune(5); },
      };
      if(presets[m]){ presets[m](); }
      localStorage.setItem('earth_mode', m);
    },
    ensure(){ if(!ctx || ctx.state==='closed'){ createCtx(); } if(ctx.state==='suspended'){ ctx.resume(); } }
  };

  // UI bindings
  document.getElementById('leftOnly').addEventListener('click', ()=>{ window.__earthAudio.ensure();
    setWidth(100); start(); if(panL){ panL.pan.value=-1; } if(panR){ panR.pan.value=-1; } health(true); }, {passive:true});
  document.getElementById('rightOnly').addEventListener('click', ()=>{ window.__earthAudio.ensure();
    setWidth(100); start(); if(panL){ panL.pan.value=1; } if(panR){ panR.pan.value=1; } health(true); }, {passive:true});
  document.getElementById('both').addEventListener('click', ()=>{ window.__earthAudio.ensure();
    setWidth(widthEl.value); start(); health(true); }, {passive:true});

  startBtn.addEventListener('click', start, {passive:true});
  stopBtn.addEventListener('click', stop, {passive:true});
  gainEl.addEventListener('input', e=>{ if(ctx){ setLevel(e.target.value); } }, {passive:true});
  freqEl.addEventListener('change', e=>{ if(ctx){ setFreq(+e.target.value); } }, {passive:true});
  detuneEl.addEventListener('input', e=>{ if(ctx){ setDetune(e.target.value); } }, {passive:true});
  widthEl.addEventListener('input', e=>{ if(ctx){ setWidth(e.target.value); } }, {passive:true});
  subCB.addEventListener('change', ()=>{ const running = ctx && ctx.state==='running'; if(running){ stop(); start(); } }, {passive:true});
  pinkCB.addEventListener('change', ()=>{ const running = ctx && ctx.state==='running'; if(running){ stop(); start(); } }, {passive:true});

  // Passive health watch
  setInterval(()=>{ const ok = !!(ctx && ctx.state==='running'); health(ok); ledCtx.className = 'led ' + (ok?'on':''); }, 900);

  // Restore remembered preferences
  const prevMode   = localStorage.getItem('earth_mode')   || 'ground';
  const prevWarm   = localStorage.getItem('earth_warmth') || 'off';
  const prevPreset = parseFloat(localStorage.getItem('earth_preset') || '128');
  window.__earthAudio.setMode(prevMode);
  if(!isNaN(prevPreset)){ window.__earthAudio.setPreset(prevPreset); }
  if(prevWarm==='on'){ label('ready'); } else { label('idle'); }
})();

/* ---------- Earth Good Points (local only) ---------- */
(() => {
  const grid = document.getElementById('pointsGrid');
  const totalEl = document.getElementById('totalPoints');
  const streakEl= document.getElementById('streakDays');

  function todayKey(){ const d=new Date(); return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; }
  function read(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }catch(e){ return fallback; } }
  function write(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }

  function updateTotals(){
    const total = read('earth_points_total', 0);
    totalEl.textContent = total;
    const streak = read('earth_points_streak', {count:0, last: null});
    streakEl.textContent = `${streak.count||0} day${(streak.count||0)===1?'':'s'}`;
  }
  function bumpStreak(){
    const key = 'earth_points_streak';
    const t = todayKey();
    const s = read(key, {count:0,last:null});
    if(s.last !== t){ s.count = (s.last? s.count+1 : 1); s.last = t; write(key,s); }
  }

  grid.addEventListener('click', (e)=>{
    const b = e.target.closest('button[data-points]'); if(!b) return;
    const pts = parseInt(b.getAttribute('data-points'),10)||0;
    const sum = (read('earth_points_total',0)||0) + pts;
    write('earth_points_total', sum);
    bumpStreak();
    updateTotals();
    b.classList.add('small'); setTimeout(()=>{ b.classList.remove('small'); }, 300);
  }, {passive:true});

  updateTotals();
})();

/* ---------- Music Deck (prefilled + Play & Tune) ---------- */
(() => {
  function idFromURL(url){
    try{
      const u = new URL(url.trim());
      if(u.hostname.includes('youtu.be')){ return u.pathname.slice(1); }
      if(u.hostname.includes('youtube.com')){
        const p = u.searchParams.get('v');
        if(p) return p;
        const list=u.searchParams.get('list'); if(list) return null;
      }
      return null;
    }catch(e){ return null; }
  }
  function load(slot){
    const urlEl = document.getElementById('yt'+slot);
    const loopEl= document.getElementById('loop'+slot);
    const frame = document.getElementById('frame'+slot);
    const id = idFromURL(urlEl.value||'');
    frame.innerHTML = '';
    if(!id) return;
    const loop = loopEl.checked ? `&loop=1&playlist=${encodeURIComponent(id)}` : '';
    const src = `https://www.youtube.com/embed/${encodeURIComponent(id)}?rel=0&modestbranding=1&playsinline=1${loop}`;
    const ifr = document.createElement('iframe');
    ifr.width = '100%'; ifr.height = '220'; ifr.src = src;
    ifr.setAttribute('allow','accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share');
    ifr.setAttribute('allowfullscreen','');
    ifr.style.border='1px solid var(--ring)'; ifr.style.borderRadius='12px'; ifr.style.background='#0b0d11';
    frame.appendChild(ifr);
  }

  ['1','2','3'].forEach(n=>document.getElementById('load'+n).addEventListener('click', ()=>load(n), {passive:true}));

  // Play & Tune buttons ‚Äî auto apply tone/mode and start
  const A = window.__earthAudio;

  // 1) The Seed ‚Äî 136.1 O-tone, Air mode, wide, light detune, no sub, no veil
  document.getElementById('playTune1').addEventListener('click', ()=>{
    load('1'); A.ensure();
    A.setPreset(136.1); A.setMode('air'); A.setWidth(1.00*100); A.setDetune(8);
    A.setOptions({sub:false, pink:false});
    const s=document.getElementById('startBtn'); if(s && !s.disabled){ s.click(); }
  }, {passive:true});

  // 2) Running With The Wolves ‚Äî 128 Warmth, Air mode, wide, small detune, no sub/veil
  document.getElementById('playTune2').addEventListener('click', ()=>{
    load('2'); A.ensure();
    A.setPreset(128); A.setMode('air'); A.setWidth(1.00*100); A.setDetune(6);
    A.setOptions({sub:false, pink:false});
    const s=document.getElementById('startBtn'); if(s && !s.disabled){ s.click(); }
  }, {passive:true});

  // 3) Holocene ‚Äî 128 Warmth, Silky mode, medium width, veil on, no sub
  document.getElementById('playTune3').addEventListener('click', ()=>{
    load('3'); A.ensure();
    A.setPreset(128); A.setMode('silky'); A.setWidth(0.70*100); A.setDetune(6);
    A.setOptions({sub:false, pink:true});
    const s=document.getElementById('startBtn'); if(s && !s.disabled){ s.click(); }
  }, {passive:true});
})();

/* ---------- Smart nudge to alter.fire when tone isn't running ---------- */
(() => {
  const hint = document.createElement('div');
  hint.className = 'note';
  hint.style.marginTop = '10px';
  hint.style.textAlign = 'center';
  hint.style.opacity = '.85';
  hint.innerHTML = 'Not feeling it yet? Try <a href="https://alter.fire" target="_blank" rel="noopener">alter.fire</a> for a stronger spark, then return to Earth.';
  let shown = false;
  setInterval(() => {
    const ctxHealthy = document.querySelector('#ledCtx')?.className.includes('on');
    if (!ctxHealthy && !shown) {
      const f = document.querySelector('footer');
      if (f) { f.appendChild(hint); shown = true; }
    }
  }, 4000);
})();
</script>
</body>
</html>
